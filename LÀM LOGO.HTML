<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Alu 3D - Thiết kế Bảng hiệu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@500;700&display=swap');
        body { font-family: 'Inter', sans-serif; cursor: default; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #3b82f6; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px;
        }
        
        #mainCanvas { cursor: crosshair; }
        .tool-active { border-color: #3b82f6 !important; background-color: #eff6ff !important; color: #1d4ed8 !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row" style="height: 92vh;">
        
        <!-- Sidebar -->
        <div class="w-full md:w-80 bg-gray-50 border-r border-gray-200 flex flex-col h-full overflow-hidden">
            
            <div class="p-5 border-b border-gray-200 bg-white">
                <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-sign text-blue-600"></i> Studio Alu 3D
                </h1>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                
                <!-- 1. Tài nguyên -->
                <section class="space-y-3">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">1. Hình ảnh</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="document.getElementById('bgInput').click()" class="flex flex-col items-center justify-center p-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-blue-500 bg-white transition-all">
                            <i class="fas fa-image text-gray-400 mb-1"></i>
                            <span class="text-[10px] font-medium" id="bgName">Ảnh nền</span>
                            <input type="file" id="bgInput" hidden accept="image/*">
                        </button>
                        <button onclick="document.getElementById('logoInput').click()" class="flex flex-col items-center justify-center p-3 border-2 border-dashed border-gray-300 rounded-xl hover:border-blue-500 bg-white transition-all">
                            <i class="fas fa-plus-circle text-gray-400 mb-1"></i>
                            <span class="text-[10px] font-medium" id="logoName">Logo</span>
                            <input type="file" id="logoInput" hidden accept="image/*">
                        </button>
                    </div>
                </section>

                <!-- 2. Xóa vật thể (MỚI) -->
                <section class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">2. Xóa vật thể cũ</h2>
                        <button id="clearPaint" class="text-[10px] text-red-500 hover:underline">Xóa tất cả vết tô</button>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-200 space-y-3 shadow-sm">
                        <div class="flex gap-2">
                            <button id="btnBrush" class="flex-1 py-2 rounded-lg border border-gray-200 text-xs font-medium flex items-center justify-center gap-1 hover:bg-gray-50 transition-all">
                                <i class="fas fa-paint-brush"></i> Cọ xóa
                            </button>
                            <input type="color" id="paintColor" value="#cccccc" title="Chọn màu để tô đè" class="w-10 h-8 rounded cursor-pointer border-0 p-0">
                        </div>
                        <div>
                            <label class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>Kích thước cọ</span> <span id="brushSizeVal">20</span>
                            </label>
                            <input type="range" id="brushSize" min="5" max="100" value="20">
                        </div>
                        <p class="text-[9px] text-gray-400 italic font-light italic">Mẹo: Chọn màu giống màu nền Alu rồi tô lên các vít, vết xước hoặc chữ cũ để xóa chúng.</p>
                    </div>
                </section>

                <!-- 3. Logo -->
                <section class="space-y-3">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">3. Chỉnh Logo</h2>
                    <div class="bg-white p-3 rounded-xl border border-gray-200 space-y-3 shadow-sm">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-gray-500 block mb-1">Vị trí X</label>
                                <input type="range" id="logoX" min="0" max="100" value="50">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 block mb-1">Vị trí Y</label>
                                <input type="range" id="logoY" min="0" max="100" value="50">
                            </div>
                        </div>
                        <div>
                            <label class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>Độ dày 3D</span> <span id="logoDepthVal">0</span>
                            </label>
                            <input type="range" id="logoDepth" min="0" max="30" value="0">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500">Màu hông:</span>
                            <input type="color" id="logoSideColor" value="#333333" class="w-full h-6 rounded cursor-pointer border-0 p-0">
                        </div>
                    </div>
                </section>

                <!-- 4. Chữ Alu -->
                <section class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">4. Chữ Alu 3D</h2>
                        <input type="checkbox" id="showText" class="w-4 h-4 rounded text-blue-600">
                    </div>
                    <div id="textControls" class="bg-white p-3 rounded-xl border border-gray-200 space-y-3 shadow-sm opacity-50 pointer-events-none transition-all">
                        <input type="text" id="textContent" placeholder="Nội dung..." class="w-full border border-gray-200 rounded-lg px-3 py-1.5 text-xs focus:ring-2 focus:ring-blue-100 outline-none" value="ALU CHỮ NỔI">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="color" id="textFaceColor" value="#ffffff" title="Màu mặt" class="w-full h-6 rounded border-0 p-0">
                            <input type="color" id="textSideColor" value="#b91c1c" title="Màu hông" class="w-full h-6 rounded border-0 p-0">
                        </div>
                        <input type="range" id="textSize" min="20" max="250" value="80">
                    </div>
                </section>

                <!-- 5. Ánh sáng -->
                <section class="space-y-3 pb-4">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">5. Ánh sáng</h2>
                    <div class="bg-gray-900 p-3 rounded-xl space-y-3">
                        <input type="range" id="ambientDarkness" min="0" max="95" value="50">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="showBeam" checked class="w-3 h-3 bg-gray-700">
                            <span class="text-[10px] text-gray-400">Hiệu ứng tia sáng đèn</span>
                        </div>
                    </div>
                </section>

            </div>

            <div class="p-5 border-t border-gray-200 bg-white">
                <button id="downloadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-cloud-download-alt"></i> Xuất thiết kế
                </button>
            </div>
        </div>

        <!-- Canvas -->
        <div class="flex-1 bg-gray-200 relative flex items-center justify-center p-4 overflow-hidden">
            <div id="canvasWrapper" class="relative">
                <div id="placeholder" class="text-center text-gray-400 flex flex-col items-center">
                    <i class="fas fa-upload text-4xl mb-3 opacity-20"></i>
                    <p class="text-sm font-light">Vui lòng tải ảnh nền Alu của bạn</p>
                </div>
                <canvas id="mainCanvas" class="hidden shadow-2xl rounded-sm"></canvas>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const el = (id) => document.getElementById(id);

        let bgImage = null;
        let logoImage = null;
        let paintLayers = []; // Lưu các vết tô xóa
        let isPainting = false;
        let currentBrushMode = false;

        const inputs = {
            bg: el('bgInput'),
            logo: el('logoInput'),
            logoX: el('logoX'),
            logoY: el('logoY'),
            logoDepth: el('logoDepth'),
            logoSideColor: el('logoSideColor'),
            showText: el('showText'),
            textContent: el('textContent'),
            textSize: el('textSize'),
            textFaceColor: el('textFaceColor'),
            textSideColor: el('textSideColor'),
            ambient: el('ambientDarkness'),
            showBeam: el('showBeam'),
            brushSize: el('brushSize'),
            paintColor: el('paintColor'),
            btnBrush: el('btnBrush'),
            clearPaint: el('clearPaint')
        };

        // Init
        function init() {
            inputs.bg.addEventListener('change', (e) => handleImage(e, 'bg'));
            inputs.logo.addEventListener('change', (e) => handleImage(e, 'logo'));
            
            inputs.showText.addEventListener('change', (e) => {
                el('textControls').className = e.target.checked ? "bg-white p-3 rounded-xl border border-gray-200 space-y-3 shadow-sm transition-all" : "bg-white p-3 rounded-xl border border-gray-200 space-y-3 shadow-sm opacity-50 pointer-events-none transition-all";
                draw();
            });

            document.querySelectorAll('input').forEach(i => i.addEventListener('input', () => { updateLabels(); draw(); }));

            // Painting Logic
            inputs.btnBrush.addEventListener('click', () => {
                currentBrushMode = !currentBrushMode;
                inputs.btnBrush.classList.toggle('tool-active', currentBrushMode);
            });

            inputs.clearPaint.addEventListener('click', () => {
                paintLayers = [];
                draw();
            });

            canvas.addEventListener('mousedown', startPaint);
            canvas.addEventListener('mousemove', paint);
            canvas.addEventListener('mouseup', endPaint);
            canvas.addEventListener('mouseleave', endPaint);

            el('downloadBtn').addEventListener('click', download);
        }

        function updateLabels() {
            el('logoDepthVal').innerText = inputs.logoDepth.value;
            el('brushSizeVal').innerText = inputs.brushSize.value;
        }

        function handleImage(e, type) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    if (type === 'bg') {
                        bgImage = img;
                        el('bgName').innerText = file.name;
                        setupCanvas();
                    } else {
                        logoImage = img;
                        el('logoName').innerText = file.name;
                    }
                    draw();
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function setupCanvas() {
            const MAX = 2000;
            let w = bgImage.width, h = bgImage.height;
            if (w > MAX) { h = h * (MAX/w); w = MAX; }
            canvas.width = w; canvas.height = h;
            canvas.classList.remove('hidden');
            el('placeholder').classList.add('hidden');
        }

        // --- Paint Functionality ---
        function startPaint(e) {
            if (!currentBrushMode || !bgImage) return;
            isPainting = true;
            paintLayers.push({
                color: inputs.paintColor.value,
                size: parseInt(inputs.brushSize.value),
                points: []
            });
            paint(e);
        }

        function paint(e) {
            if (!isPainting) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            paintLayers[paintLayers.length - 1].points.push({x, y});
            draw();
        }

        function endPaint() { isPainting = false; }

        function draw() {
            if (!bgImage) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. Ảnh gốc
            ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

            // 2. Vẽ các lớp tô xóa (Object Removal)
            paintLayers.forEach(layer => {
                ctx.beginPath();
                ctx.strokeStyle = layer.color;
                ctx.lineWidth = layer.size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                layer.points.forEach((p, i) => {
                    if (i === 0) ctx.moveTo(p.x, p.y);
                    else ctx.lineTo(p.x, p.y);
                });
                ctx.stroke();
            });

            // 3. Logo
            const lx = parseInt(inputs.logoX.value) / 100 * canvas.width;
            const ly = parseInt(inputs.logoY.value) / 100 * canvas.height;
            const lDepth = parseInt(inputs.logoDepth.value);
            
            if (logoImage) {
                const lW = canvas.width * 0.3 * (logoImage.width/logoImage.height);
                const lH = canvas.width * 0.3;
                const fx = lx - lW/2, fy = ly - lH/2;

                if (lDepth > 0) {
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetX = lDepth + 2; ctx.shadowOffsetY = lDepth + 2;
                    
                    const tC = document.createElement('canvas');
                    tC.width = lW; tC.height = lH;
                    const tCtx = tC.getContext('2d');
                    tCtx.drawImage(logoImage, 0, 0, lW, lH);
                    tCtx.globalCompositeOperation = 'source-in';
                    tCtx.fillStyle = inputs.logoSideColor.value;
                    tCtx.fillRect(0, 0, lW, lH);

                    for(let i=lDepth; i>0; i--) {
                        ctx.drawImage(tC, fx+i, fy+i, lW, lH);
                        ctx.shadowColor = 'transparent';
                    }
                    ctx.restore();
                }
                ctx.drawImage(logoImage, fx, fy, lW, lH);
            }

            // 4. Chữ
            if (inputs.showText.checked) {
                const text = inputs.textContent.value;
                const size = parseInt(inputs.textSize.value);
                const tx = parseInt(el('logoX').value) / 100 * canvas.width; // Mượn tọa độ X của logo hoặc tách riêng nếu cần
                const ty = (parseInt(el('logoY').value) + 20) / 100 * canvas.height;

                ctx.save();
                ctx.font = `bold ${size}px 'Oswald'`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                
                // Shadow/Side
                ctx.fillStyle = inputs.textSideColor.value;
                ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5;
                ctx.fillText(text, tx+5, ty+5);
                
                ctx.fillStyle = inputs.textFaceColor.value;
                ctx.shadowColor = 'transparent';
                ctx.fillText(text, tx, ty);
                ctx.restore();
            }

            // 5. Ánh sáng
            const amb = parseInt(inputs.ambient.value) / 100;
            if (amb > 0) {
                const grad = ctx.createRadialGradient(lx, ly, 0, lx, ly, canvas.width*0.6);
                grad.addColorStop(0, 'transparent');
                grad.addColorStop(1, `rgba(0,0,0,${amb})`);
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        function download() {
            const link = document.createElement('a');
            link.download = 'thiet-ke-alu.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        init();
    </script>
</body>
</html>